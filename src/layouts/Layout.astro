---
import Header from '~/components/Header.astro';
import Footer from '~/components/Footer.astro';
import "../styles/citations.css";

// O frontmatter deste layout não precisa mais saber sobre 'aulaAtual' ou 'referencias'
const { title } = Astro.props;

// Lógica segura que garante que a base sempre termine com uma barra
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
---
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title} - Oficina de Cientistas</title>
    <script is:inline>
  (function () {
    try {
      const root = document.documentElement; // <html>
      root.classList.add('ml-preload'); // evita flicker/transições no 1º paint

      // aceita '1' ou 'true' (legado)
      const v = localStorage.getItem('oficina.modoLeitura');
      const on = v === '1' || v === 'true';
      if (on) root.classList.add('modo-leitura-ativo', 'modo-leitura-handle-pronto');
    } catch (e) {}
  })();
</script>
    <link rel="stylesheet" href={`${base}estilos.css`}>
    <link rel="icon" type="image/png" href={`${base}favicon-96x96.png`} sizes="96x96" />
    <link rel="apple-touch-icon" href={`${base}apple-touch-icon.png`}>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="pagina-container">
        <Header />
        <slot />
        <Footer />
    </div>

    <script is:inline>
      (function(){
        // >>> MODIFICADO: Carregar refs do frontmatter a partir do JSON embutido
        /** @type {Array<{key:string, text?:string, author?:string, year?:string, title?:string, doi?:string, url?:string, scholar_query?:string}>} */
        let REFS = [];
        try {
          const el = document.getElementById('oc-refs');
          if (el) REFS = JSON.parse(el.textContent || '[]');
        } catch (e) {
          console.warn('OC: não consegui ler o JSON de referências', e);
        }

        // ======== Helpers de links (código restante inalterado) ========
        function scholarURL(ref){
          const q = ref.scholar_query || [ref.author, ref.title, ref.year].filter(Boolean).join(' ');
          return q ? 'https://scholar.google.com/scholar?q=' + encodeURIComponent(q) : null;
        }
        function makeLink(href, label){
          const a = document.createElement('a');
          a.href = href; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = label;
          return a;
        }

        // ======== Numeração & Transformação ========
        function transformCitations(){
          const refByKey = new Map(REFS.map(r => [r.key, r]));
          const numByKey = new Map();
          const order = [];

          document.querySelectorAll('cite.oc-cite[data-key]').forEach((c) => {
            const key = c.getAttribute('data-key');
            if (!key) return;

            if (!numByKey.has(key)) { numByKey.set(key, order.length + 1); order.push(key); }
            const n = numByKey.get(key);

            // botão [n]
            const btn = document.createElement('button');
            btn.className = 'oc-cite-button';
            btn.type = 'button';
            btn.setAttribute('data-key', key);
            btn.setAttribute('data-cite-num', String(n));
            btn.setAttribute('aria-label', `Ver referência [${n}]`);
            const sup = document.createElement('sup');
            sup.className = 'oc-cite-sup';
            sup.textContent = `[${n}]`;
            btn.appendChild(sup);

            // popover
            const pop = document.createElement('div');
            pop.className = 'oc-popover';
            pop.hidden = true;
            pop.setAttribute('role', 'dialog');
            pop.setAttribute('aria-modal', 'false');
            pop.setAttribute('data-cite-popover', String(n));

            const ref = refByKey.get(key);
            const body = document.createElement('div');
            body.className = 'oc-pop-body';

            const p = document.createElement('p');
            p.className = 'oc-pop-text';
            p.textContent = ref ? (ref.text || [ref.author, ref.year, ref.title].filter(Boolean).join(' — '))
                                : `Referência não encontrada: ${key}`;
            body.appendChild(p);

            // links (DOI · Link · Google Scholar)
            const links = [];
            if (ref?.doi) links.push(makeLink(ref.doi, 'DOI'));
            if (ref?.url) links.push(makeLink(ref.url, 'Link'));
            const scholar = ref ? scholarURL(ref) : null;
            if (scholar) links.push(makeLink(scholar, 'Google Scholar'));
            if (links.length) {
              const lp = document.createElement('p');
              lp.className = 'oc-pop-links';
              links.forEach((a, i) => {
                if (i) lp.append(document.createTextNode(' · '));
                lp.append(a);
              });
              body.appendChild(lp);
            }

            const close = document.createElement('button');
            close.className = 'oc-pop-close';
            close.type = 'button';
            close.setAttribute('aria-label', 'Fechar');
            close.textContent = '×';

            pop.append(close, body);

            // troca <cite> por [botão, popover]
            c.replaceWith(btn, pop);
          });

          // ======== Lista final ========
          const host = document.querySelector('[data-ref-list]');
          if (host) {
            const ol = document.createElement('ol');
            ol.className = 'oc-ref-ol';

            order.forEach((key, i) => {
              const li = document.createElement('li');
              li.className = 'oc-ref-item';
              li.id = `ref-${i+1}`;

              const ref = REFS.find(r => r.key === key);
              if (ref) {
                li.append(document.createTextNode(ref.text || [ref.author, ref.year, ref.title].filter(Boolean).join(' — ')));

                const links = [];
                if (ref.doi) links.push(['DOI', ref.doi]);
                if (ref.url) links.push(['Link', ref.url]);
                const sch = scholarURL(ref);
                if (sch) links.push(['Google Scholar', sch]);

                if (links.length) {
                  li.append(document.createTextNode(' '));
                  const span = document.createElement('span');
                  span.className = 'oc-ref-links';
                  links.forEach((pair, j) => {
                    if (j) span.append(document.createTextNode(' · '));
                    const a = document.createElement('a');
                    a.href = pair[1]; a.target = '_blank'; a.rel = 'noopener noreferrer'; a.textContent = pair[0];
                    span.append(a);
                  });
                  li.append(span);
                }
              } else {
                li.append(document.createTextNode(`[${i+1}] Referência não encontrada: ${key}`));
              }

              ol.appendChild(li);
            });

            // Título + lista
            const h2 = document.createElement('h2');
            h2.className = 'oc-ref-title';
            h2.textContent = 'Referências';

            host.replaceChildren(h2, ol);
          }
        }

        // ======== Popover (abrir/fechar/posicionar) ========
        function bindPopovers(){
          let open = null; // { btn, pop }

          function closeOpen(){
            if (!open) return;
            open.pop.setAttribute('hidden','');
            open.btn.setAttribute('aria-expanded','false');
            open = null;
          }
          function positionPopover(btn, pop){
            const r = btn.getBoundingClientRect();
            const gap = 8;
            const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
            pop.style.left = '0px';
            pop.style.top = '-10000px';
            pop.removeAttribute('hidden');
            const pr = pop.getBoundingClientRect();
            let left = r.left;
            let top = r.bottom + gap;
            if (left + pr.width > vw - 8) left = vw - pr.width - 8;
            if (left < 8) left = 8;
            if (top + pr.height > vh - 8) top = Math.max(8, r.top - pr.height - gap);
            pop.style.left = Math.round(left) + 'px';
            pop.style.top = Math.round(top) + 'px';
          }

          document.querySelectorAll('.oc-cite-button:not([data-oc-bound])').forEach((btn) => {
            btn.dataset.ocBound = '1';
            btn.addEventListener('click', (e) => {
              const b = e.currentTarget;
              const pop = b.nextElementSibling;
              if (!pop || !pop.classList.contains('oc-popover')) return;
              if (open && open.pop === pop) { closeOpen(); return; }
              closeOpen();
              positionPopover(b, pop);
              b.setAttribute('aria-expanded','true');
              open = { btn: b, pop };
            });
          });

          if (!window.__oc_globalHandlers){
            document.addEventListener('click', (e) => {
              if (!open) return;
              const path = e.composedPath ? e.composedPath() : (e.path || []);
              if (path.includes(open.pop) || path.includes(open.btn)) return;
              closeOpen();
            });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeOpen(); });
            window.addEventListener('scroll', () => closeOpen(), { passive: true });
            window.addEventListener('resize', () => closeOpen());
            window.__oc_globalHandlers = true;
          }
        }

        // ======== Bootstrap ========
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => { transformCitations(); bindPopovers(); });
        } else {
          transformCitations(); bindPopovers();
        }
      })();
    </script>

    <script>
        const yearSpan = document.getElementById('currentYear');
        if (yearSpan) {
            yearSpan.textContent = new Date().getFullYear();
        }
    </script>
</body>
</html>