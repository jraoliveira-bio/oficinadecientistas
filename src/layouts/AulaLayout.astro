---
// src/layouts/AulaLayout.astro
import { getCollection } from 'astro:content';
import Layout from '~/layouts/Layout.astro'; // Importa o layout principal

// (Opcional) garante o CSS das citaÃ§Ãµes nesta pÃ¡gina
import hydrateUrl from '../scripts/citations-hydrate.js?url';
import "../styles/citations.css";

// Recebe a 'aulaAtual' que foi passada pelo [slug].astro
const { aulaAtual } = Astro.props;
const referencias = aulaAtual?.data?.references ?? [];
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

// ðŸ”§ Serializa as referÃªncias sem <script>, para evitar o bug do compilador
const refsAttr = encodeURIComponent(JSON.stringify(referencias));

// Busca todas as aulas da coleÃ§Ã£o para montar o menu
const todasAsAulas = (await getCollection('curso-escrita'))
  .filter(aula => aula.data.menu === true)
  .sort((a, b) => a.data.ordem - b.data.ordem);
---

<script is:inline>
  (function () {
    try {
      // Desliga qualquer transiÃ§Ã£o no 1Âº paint
      document.body.classList.add('ml-preload');

      // Se estava em modo leitura, jÃ¡ comeÃ§a assim e com o handle pronto
      if (localStorage.getItem('oficina.modoLeitura') === '1') {
        document.documentElement.classList.add('modo-leitura-ativo', 'modo-leitura-handle-pronto');
        document.body.classList.add('modo-leitura-ativo', 'modo-leitura-handle-pronto');
      }
    } catch (e) {}
  })();
</script>

<Layout title={aulaAtual.data.title}>
  <main class="container-sala-de-aula">
    <aside class="menu-aulas">
      <button
        id="toggle-leitura"
        class="toggle-leitura"
        data-leitura-toggle
        aria-pressed="false"
        aria-label="Ativar modo leitura"
        title="Modo leitura"
        type="button"
      >
        <span class="icone" aria-hidden="true">â«·</span>
        <span class="texto">Modo leitura</span>
      </button>

      <h3>Escrita CientÃ­fica</h3>
      <ol>
        {todasAsAulas.map(aula => {
          const aulaUrl = `${base}cursos/curso-escrita/${aula.slug}`;
          const isAtiva = aula.slug === aulaAtual.slug;
          return (
            <li class:list={[{'aula-ativa': isAtiva}]}>
              <a href={aulaUrl}>
                <i class="fas fa-video"></i> {aula.data.title}
              </a>
            </li>
          )
        })}
      </ol>
    </aside>

    <button
      class="handle-leitura"
      data-leitura-toggle
      aria-label="Reabrir menu"
      title="Reabrir menu"
      type="button"
    >
      <span class="icone" aria-hidden="true">â«¸</span>
    </button>

    <div class="conteudo-aula">
      <article class="texto-aula">
        <slot />

        <!-- ðŸ”§ Dados das referÃªncias sem <script>; o hydrator lÃª daqui -->
        <meta id="oc-refs" data-refs={refsAttr} />
<script type="module" src={hydrateUrl}></script>

      </article>
    </div>
  </main>
</Layout>

<style>
  :root {
    --t: 0.5s;
    --easing: ease-in-out;
    --gap-sala: 1.5rem;
    --menu-largura: 320px;
    --conteudo-max-padrao: 70ch;
    --conteudo-max: 65ch;
    --conteudo-pad: clamp(1rem, 2vw, 2rem);
    --handle-top: .5rem;
    --handle-left: .5rem;
  }
  .container-sala-de-aula {
    display: grid;
    grid-template-columns: var(--menu-largura) 1fr;
    gap: var(--gap-sala);
    transition: grid-template-columns var(--t) var(--easing);
  }
  .menu-aulas {
    position: sticky;
    top: var(--menu-stick-top, 0.5rem);
    align-self: start;
    height: max-content;
    transform: translateX(0);
    transition: transform var(--t) var(--easing);
    will-change: transform;
    overflow: hidden;
    z-index: 2;
  }
  .conteudo-aula {
    min-width: 0;
    transition: padding var(--t) var(--easing), margin var(--t) var(--easing);
  }
  .texto-aula {
    margin-inline: auto;
    max-width: var(--conteudo-max-padrao);
    transition: max-width var(--t) var(--easing);
  }
  .texto-aula :is(img, video, canvas, iframe, table) {
    max-width: 100%;
  }
  .texto-aula pre {
    overflow-x: auto;
  }
  :global(.texto-aula) {
    text-align: justify;
    text-align-last: start;
  }
  :global(.texto-aula p) {
    hyphens: auto;
    -webkit-hyphens: auto;
    -ms-hyphens: auto;
    overflow-wrap: break-word;
    word-break: normal;
  }
  :global(.texto-aula :is(h1,h2,h3,h4,h5,h6,li,pre,code,blockquote,figcaption)) {
    text-align: start;
    hyphens: manual;
  }
  .toggle-leitura {
    position: absolute;
    top: .5rem;
    right: .5rem;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .4rem .6rem;
    border: 1px solid currentColor;
    border-radius: .5rem;
    background: transparent;
    cursor: pointer;
    font: 500 0.9rem/1.1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  .toggle-leitura .icone { transition: transform var(--t) var(--easing); }
  .handle-leitura {
    display: none;
    position: fixed;
    top: var(--handle-top);
    left: var(--handle-left);
    z-index: 9999;
    padding: .4rem .55rem;
    border: 1px solid currentColor;
    border-radius: .5rem;
    background: color-mix(in srgb, Canvas 85%, CanvasText 15%);
    cursor: pointer;
    font: 600 0.95rem/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    box-shadow: 0 2px 10px rgb(0 0 0 / .08);
  }
  :global(.conteudo-aula .nota-de-margem .nota) {
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--t) var(--easing);
  }
  body.modo-leitura-ativo .container-sala-de-aula {
    grid-template-columns: 0 1fr;
  }
  body.modo-leitura-ativo .menu-aulas {
    transform: translateX(-100%);
    pointer-events: none;
  }
  body.modo-leitura-ativo .handle-leitura {
    display: inline-flex;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transform: translateX(-4px);
    transition:
      opacity var(--t) var(--easing),
      transform var(--t) var(--easing),
      visibility 0s linear var(--t);
  }
  body.modo-leitura-ativo.modo-leitura-handle-pronto .handle-leitura {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translateX(0);
    transition-delay: 0s, 0s, 0s;
  }
  body.modo-leitura-ativo :global(.conteudo-aula .nota-de-margem .nota) {
    opacity: 1;
    pointer-events: auto;
  }
  body.modo-leitura-ativo .texto-aula {
    max-width: var(--conteudo-max, 70ch);
  }
  body.ml-preload .container-sala-de-aula,
  body.ml-preload .menu-aulas,
  body.ml-preload .conteudo-aula,
  body.ml-preload .handle-leitura,
  body.ml-preload :global(.conteudo-aula .nota-de-margem .nota) {
    transition: none !important;
  }
  body.ml-preload .handle-leitura {
    visibility: hidden;
  }
  .toggle-leitura:focus-visible,
  .handle-leitura:focus-visible {
    outline: 3px solid Highlight;
    outline-offset: 2px;
  }
  @media (prefers-reduced-motion: reduce) {
    .container-sala-de-aula,
    .menu-aulas,
    .conteudo-aula,
    :global(.conteudo-aula .nota-de-margem .nota),
    .toggle-leitura,
    .handle-leitura,
    .toggle-leitura .icone {
      transition: none !important;
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const LS_KEY   = 'oficina.modoLeitura';
    const ROOT     = document.documentElement;
    const BODY     = document.body;
    const container = document.querySelector('.container-sala-de-aula');
    const menu      = document.querySelector('.menu-aulas');
    const menuBtn   = document.querySelector('.menu-aulas .toggle-leitura');
    const toggles   = Array.from(document.querySelectorAll('[data-leitura-toggle], #toggle-leitura, .toggle-leitura, .handle-leitura'));

    if (!container || !menu || !toggles.length) {
      BODY.classList.remove('ml-preload');
      return;
    }

    function setPressed(active) {
      for (const btn of toggles) {
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        const isHandle = btn.classList.contains('handle-leitura');
        const label = active ? 'Sair do modo leitura' : (isHandle ? 'Reabrir menu' : 'Ativar modo leitura');
        btn.setAttribute('aria-label', label);
        btn.title = label;
      }
    }

    function placeHandleAnchored() {
      if (menuBtn) {
        const rTop = menuBtn.getBoundingClientRect();
        ROOT.style.setProperty('--handle-top', `${Math.max(8, Math.round(rTop.top))}px`);
      }
      const rLeft = container.getBoundingClientRect();
      ROOT.style.setProperty('--handle-left', `${Math.max(8, Math.round(rLeft.left))}px`);
    }

    function revealHandleAfterMenuSlidesOut() {
      const fallback = setTimeout(() => {
        ROOT.classList.add('modo-leitura-handle-pronto');
        BODY.classList.add('modo-leitura-handle-pronto');
      }, 550);
      function onEnd(e) {
        if (e.propertyName !== 'transform') return;
        clearTimeout(fallback);
        menu.removeEventListener('transitionend', onEnd);
        ROOT.classList.add('modo-leitura-handle-pronto');
        BODY.classList.add('modo-leitura-handle-pronto');
      }
      menu.addEventListener('transitionend', onEnd, { once: true });
    }

    function syncClasses(active) {
      [ROOT, BODY].forEach(el => {
        el.classList.toggle('modo-leitura-ativo', active);
        if (!active) el.classList.remove('modo-leitura-handle-pronto');
      });
    }

    const startActive = ROOT.classList.contains('modo-leitura-ativo');
    if (startActive) {
      placeHandleAnchored();
      setPressed(true);
    } else {
      setPressed(false);
    }

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        BODY.classList.remove('ml-preload');
      });
    });

    toggles.forEach(btn => btn.addEventListener('click', () => {
      const next = !ROOT.classList.contains('modo-leitura-ativo');
      syncClasses(next);
      setPressed(next);
      localStorage.setItem(LS_KEY, next ? '1' : '0');

      if (next) {
        placeHandleAnchored();
        revealHandleAfterMenuSlidesOut();
      }
    }));

    window.addEventListener('resize', () => {
      if (ROOT.classList.contains('modo-leitura-ativo')) placeHandleAnchored();
    }, { passive: true });

    const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
    if (mq.matches) {
      toggles.forEach(btn => {
        btn.addEventListener('click', () => {
          if (ROOT.classList.contains('modo-leitura-ativo')) {
            ROOT.classList.add('modo-leitura-handle-pronto');
            BODY.classList.add('modo-leitura-handle-pronto');
          }
        });
      });
    }
  });
</script>
