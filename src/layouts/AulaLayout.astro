---
// src/layouts/AulaLayout.astro
import { getCollection } from 'astro:content';
import Layout from '~/layouts/Layout.astro'; // Importa o layout principal

// Recebe a 'aulaAtual' que foi passada pelo [slug].astro
const { aulaAtual } = Astro.props;
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

// Busca todas as aulas da coleção para montar o menu
const todasAsAulas = (await getCollection('curso-escrita'))
  .filter(aula => aula.data.menu === true) // Adiciona o filtro aqui
  .sort((a, b) => a.data.ordem - b.data.ordem);
---

<!-- Prepara o 1º paint e estado inicial coerente em <html> e <body> -->
<script is:inline>
  (function () {
    try {
      // Desliga qualquer transição no 1º paint
      document.body.classList.add('ml-preload');

      // Se estava em modo leitura, já começa assim e com o handle pronto
      if (localStorage.getItem('oficina.modoLeitura') === '1') {
        document.documentElement.classList.add('modo-leitura-ativo', 'modo-leitura-handle-pronto');
        document.body.classList.add('modo-leitura-ativo', 'modo-leitura-handle-pronto');
      }
    } catch (e) {}
  })();
</script>

<Layout title={aulaAtual.data.title}>
  <main class="container-sala-de-aula">
    <aside class="menu-aulas">
      <button
        id="toggle-leitura"
        class="toggle-leitura"
        data-leitura-toggle 
        aria-pressed="false"
        aria-label="Ativar modo leitura"
        title="Modo leitura"
        type="button"
      >
        <span class="icone" aria-hidden="true">⫷</span>
        <span class="texto">Modo leitura</span>
      </button>

      <h3>Escrita Científica</h3>
      <ol>
        {todasAsAulas.map(aula => {
          const aulaUrl = `${base}cursos/curso-escrita/${aula.slug}`;
          const isAtiva = aula.slug === aulaAtual.slug;
          return (
            <li class:list={[{'aula-ativa': isAtiva}]}>
              <a href={aulaUrl}>
                <i class="fas fa-video"></i> {aula.data.title}
              </a>
            </li>
          )
        })}
      </ol>
    </aside>

    <button
      class="handle-leitura"
      data-leitura-toggle
      aria-label="Reabrir menu"
      title="Reabrir menu"
      type="button"
    >
      <span class="icone" aria-hidden="true">⫸</span>
    </button>

    <div class="conteudo-aula">
      <!-- Wrapper que recebe o limite de largura em caracteres -->
      <article class="texto-aula">
        <slot />
      </article>
    </div>
  </main>
</Layout>

<style>
  :root {
    --t: 0.5s;
    --easing: ease-in-out;
    --gap-sala: 1.5rem;
    --menu-largura: 320px;

    /* Larguras máximas por caractere */
    --conteudo-max-padrao: 70ch;  /* navegação (menu visível) */
    --conteudo-max: 65ch;         /* modo leitura (menu oculto) */

    --conteudo-pad: clamp(1rem, 2vw, 2rem);
    --handle-top: .5rem;    /* mesma altura do botão do menu */
    --handle-left: .5rem;   /* margem esquerda do puxador */
  }

  .container-sala-de-aula {
    display: grid;
    grid-template-columns: var(--menu-largura) 1fr;
    gap: var(--gap-sala);
    transition: grid-template-columns var(--t) var(--easing);
  }

  .menu-aulas {
    /* Torna o menu "grudado" no topo ao rolar */
    position: sticky;
    top: var(--menu-stick-top, 0.5rem);
    align-self: start;     /* necessário em grid para o sticky funcionar bem */
    height: max-content;   /* evita esticar além do conteúdo */

    transform: translateX(0);
    transition: transform var(--t) var(--easing);
    will-change: transform;
    overflow: hidden;      /* evita conteúdo “vazar” ao sair */
    z-index: 2;
  }

  .conteudo-aula {
    min-width: 0;
    transition: padding var(--t) var(--easing), margin var(--t) var(--easing);
  }

  /* === Largura/centralização do conteúdo (modo padrão) === */
  .texto-aula {
    margin-inline: auto;
    max-width: var(--conteudo-max-padrao);
    transition: max-width var(--t) var(--easing);
  }

  /* Evitar estouro de mídia dentro da coluna */
  .texto-aula :is(img, video, canvas, iframe, table) {
    max-width: 100%;
  }
  .texto-aula pre {
    overflow-x: auto;
  }
/* Alcança o conteúdo slottado pelo Astro */
:global(.texto-aula) {
  /* aplica por herança */
  text-align: justify;
  text-align-last: start;      /* última linha não forçada */
}

/* Ajustes específicos de parágrafo */
:global(.texto-aula p) {
  hyphens: auto;               /* precisa de <html lang="pt-br"> */
  -webkit-hyphens: auto;
  -ms-hyphens: auto;
  overflow-wrap: break-word;
  word-break: normal;
}

/* Não justificar onde costuma ficar ruim */
:global(.texto-aula :is(h1,h2,h3,h4,h5,h6,li,pre,code,blockquote,figcaption)) {
  text-align: start;
  hyphens: manual;
}

  /* Botão do menu (estado normal) */
  .toggle-leitura {
    position: absolute;
    top: .5rem;
    right: .5rem;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .4rem .6rem;
    border: 1px solid currentColor;
    border-radius: .5rem;
    background: transparent;
    cursor: pointer;
    font: 500 0.9rem/1.1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  .toggle-leitura .icone { transition: transform var(--t) var(--easing); }

  /* Handle (puxador) — oculto por padrão */
  .handle-leitura {
    display: none;
    position: fixed;
    top: var(--handle-top);
    left: var(--handle-left);
    z-index: 9999;
    padding: .4rem .55rem;
    border: 1px solid currentColor;
    border-radius: .5rem;
    background: color-mix(in srgb, Canvas 85%, CanvasText 15%);
    cursor: pointer;
    font: 600 0.95rem/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    box-shadow: 0 2px 10px rgb(0 0 0 / .08);
  }

  /* Notas de margem invisíveis no modo navegação */
  :global(.conteudo-aula .nota-de-margem .nota) {
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--t) var(--easing);
  }

  /* ===== MODO LEITURA ATIVO ===== */
  body.modo-leitura-ativo .container-sala-de-aula {
    grid-template-columns: 0 1fr; /* menu some da grid */
  }
  body.modo-leitura-ativo .menu-aulas {
    transform: translateX(-100%); /* off-canvas real */
    pointer-events: none;
  }

  /* Enquanto o menu está animando para fora:
     - handle já está no DOM, mas INVISÍVEL e sem clique */
  body.modo-leitura-ativo .handle-leitura {
    display: inline-flex;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transform: translateX(-4px);
    transition:
      opacity var(--t) var(--easing),
      transform var(--t) var(--easing),
      visibility 0s linear var(--t); /* visibilidade só troca depois da duração */
  }

  /* Quando a animação do menu termina, JS adiciona esta classe:
     - handle faz fade-in suave e fica clicável */
  body.modo-leitura-ativo.modo-leitura-handle-pronto .handle-leitura {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transform: translateX(0);
    transition-delay: 0s, 0s, 0s;
  }

  /* Notas de margem visíveis apenas no modo leitura */
  body.modo-leitura-ativo :global(.conteudo-aula .nota-de-margem .nota) {
    opacity: 1;
    pointer-events: auto;
  }

  /* Largura do texto no modo leitura (usa a variável correta) */
  body.modo-leitura-ativo .texto-aula {
    max-width: var(--conteudo-max, 70ch);
  }

  /* Desliga transições no 1º paint e evita "flash" do handle */
  body.ml-preload .container-sala-de-aula,
  body.ml-preload .menu-aulas,
  body.ml-preload .conteudo-aula,
  body.ml-preload .handle-leitura,
  body.ml-preload :global(.conteudo-aula .nota-de-margem .nota) {
    transition: none !important;
  }
  body.ml-preload .handle-leitura {
    visibility: hidden; /* some até medirmos posição */
  }

  /* Acessibilidade */
  .toggle-leitura:focus-visible,
  .handle-leitura:focus-visible {
    outline: 3px solid Highlight;
    outline-offset: 2px;
  }

  @media (prefers-reduced-motion: reduce) {
    .container-sala-de-aula,
    .menu-aulas,
    .conteudo-aula,
    :global(.conteudo-aula .nota-de-margem .nota),
    .toggle-leitura,
    .handle-leitura,
    .toggle-leitura .icone {
      transition: none !important;
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const LS_KEY   = 'oficina.modoLeitura';
    const ROOT     = document.documentElement; // <html>
    const BODY     = document.body;

    const container = document.querySelector('.container-sala-de-aula');
    const menu      = document.querySelector('.menu-aulas');
    const menuBtn   = document.querySelector('.menu-aulas .toggle-leitura');
    const toggles   = Array.from(document.querySelectorAll('[data-leitura-toggle], #toggle-leitura, .toggle-leitura, .handle-leitura'));

    if (!container || !menu || !toggles.length) {
      BODY.classList.remove('ml-preload'); // corrigido: remove do body
      return;
    }

    function setPressed(active) {
      for (const btn of toggles) {
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        const isHandle = btn.classList.contains('handle-leitura');
        const label = active ? 'Sair do modo leitura' : (isHandle ? 'Reabrir menu' : 'Ativar modo leitura');
        btn.setAttribute('aria-label', label);
        btn.title = label;
      }
    }

    function placeHandleAnchored() {
      if (menuBtn) {
        const rTop = menuBtn.getBoundingClientRect();
        ROOT.style.setProperty('--handle-top', `${Math.max(8, Math.round(rTop.top))}px`);
      }
      const rLeft = container.getBoundingClientRect();
      ROOT.style.setProperty('--handle-left', `${Math.max(8, Math.round(rLeft.left))}px`);
    }

    function revealHandleAfterMenuSlidesOut() {
      const fallback = setTimeout(() => {
        ROOT.classList.add('modo-leitura-handle-pronto');
        BODY.classList.add('modo-leitura-handle-pronto');
      }, 550);
      function onEnd(e) {
        if (e.propertyName !== 'transform') return;
        clearTimeout(fallback);
        menu.removeEventListener('transitionend', onEnd);
        ROOT.classList.add('modo-leitura-handle-pronto');
        BODY.classList.add('modo-leitura-handle-pronto');
      }
      menu.addEventListener('transitionend', onEnd, { once: true });
    }

    function syncClasses(active) {
      [ROOT, BODY].forEach(el => {
        el.classList.toggle('modo-leitura-ativo', active);
        if (!active) el.classList.remove('modo-leitura-handle-pronto');
      });
    }

    // Estado inicial: agora o script do head já setou também em <html>, então funciona
    const startActive = ROOT.classList.contains('modo-leitura-ativo');
    if (startActive) {
      placeHandleAnchored();
      setPressed(true);
    } else {
      setPressed(false);
    }

    // Libera transições após o primeiro paint estável
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        BODY.classList.remove('ml-preload'); // corrigido: remove do body
      });
    });

    toggles.forEach(btn => btn.addEventListener('click', () => {
      const next = !ROOT.classList.contains('modo-leitura-ativo');
      syncClasses(next);
      setPressed(next);
      localStorage.setItem(LS_KEY, next ? '1' : '0');

      if (next) {
        // usuário ativou agora: posiciona handle e revela após o slide do menu
        placeHandleAnchored();
        revealHandleAfterMenuSlidesOut();
      }
    }));

    // Reancora handle em resize
    window.addEventListener('resize', () => {
      if (ROOT.classList.contains('modo-leitura-ativo')) placeHandleAnchored();
    }, { passive: true });

    // Motion reduzido: revela handle sem esperar transição
    const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
    if (mq.matches) {
      toggles.forEach(btn => {
        btn.addEventListener('click', () => {
          if (ROOT.classList.contains('modo-leitura-ativo')) {
            ROOT.classList.add('modo-leitura-handle-pronto');
            BODY.classList.add('modo-leitura-handle-pronto');
          }
        });
      });
    }
  });
</script>
