---
/**
 * Componente: NotaDeMargem
 * Uso: "embrulhar" (wrap) um parágrafo e exibir uma nota curta na margem.
 *
 * Props:
 * - resumo (string)         -> texto curto que aparece na margem (obrigatório)
 * - lado ('direita'|'esquerda') -> lado onde a nota aparece no desktop (default: 'direita')
 * - cor ('jade'|'vinho'|hex) -> cor do texto/realce da nota (default: 'jade')
 * - largura (CSS length)    -> largura da caixa da nota (default: '18ch')
 * - offset (CSS length)     -> distância entre o texto e a nota (default: '1.5rem')
 * - icone (string)          -> opcional; ícone da nota (default: '✎')
 */

interface Props {
  resumo: string;
  lado?: 'direita' | 'esquerda';
  cor?: 'jade' | 'vinho' | string;
  largura?: string;
  offset?: string;
  icone?: string;
}

const {
  resumo,
  lado = 'direita',
  cor = 'jade',
  largura = '18ch',
  offset = '1.5rem',
  icone = '✎',
} = Astro.props;

// Resolve cor principal (hex) e um fundo suave para o modo mobile
const corHex =
  cor === 'jade' ? '#00695C' :
  cor === 'vinho' ? '#8c4b4b' :
  cor; // permite hex ou qualquer cor CSS válida

// Fundo suave para mobile (fallbacks pensados para jade/vinho; se custom, usa um neutro claro)
const bgMobile =
  corHex.toLowerCase() === '#00695c' ? '#e6f2f0' :
  corHex.toLowerCase() === '#8c4b4b' ? '#f5ecec' :
  '#f7f9f8';
---

<!--
  Estrutura:
  - wrapper: posicionamento relativo
  - .nota   : posição absoluta que "sangra" para fora da coluna no desktop
  - .conteudo: mantém fluxo normal do parágrafo/slot
-->
<div
  class="nota-de-margem"
  data-lado={lado}
  style={`--nota-largura:${largura}; --nota-cor:${corHex}; --nota-offset:${offset}; --nota-bg-mobile:${bgMobile};`}
>
  <aside class="nota" role="note" aria-label="Nota de margem">
    <span class="icone" aria-hidden="true">{icone}</span>
    <span class="texto">{resumo}</span>
  </aside>

  <div class="conteudo">
    <slot />
  </div>
</div>

<style>
  /* Carrega a fonte manuscrita apenas aqui (componente autocontido) */
  @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@600;700&display=swap');

  .nota-de-margem {
    position: relative;
    overflow: visible; /* permite "sangrar" a anotação para fora */
  }

  .conteudo {
    position: relative;
    z-index: 0;
  }

  .nota {
    position: absolute;
    top: 0.15em; /* aproxima da primeira linha do parágrafo */
    width: var(--nota-largura);
    font-family: 'Caveat', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, 'Helvetica Neue', 'Noto Sans', sans-serif;
    font-weight: 700;
    font-size: 0.95rem; /* menor que o corpo do texto */
    line-height: 1.1;
    color: var(--nota-cor);
    z-index: 1;
    user-select: text;
    /* Leve sensação "manual" sem exagerar */
    filter: saturate(1.05);
    text-wrap: balance;
  }

  .nota .icone {
    display: inline-block;
    margin-right: 0.25rem;
    transform: translateY(-0.05em);
  }

  /* Posicionamento lateral no desktop */
  .nota-de-margem[data-lado="direita"] .nota {
    left: 100%;
    margin-left: var(--nota-offset);
    transform: rotate(1deg);
    text-align: left;
  }

  .nota-de-margem[data-lado="esquerda"] .nota {
    right: 100%;
    margin-right: var(--nota-offset);
    transform: rotate(-1deg);
    text-align: right;
  }

  /* Acessibilidade: mantêm contraste em temas muito claros */
  @media (prefers-contrast: more) {
    .nota { text-decoration-thickness: 0.08em; }
  }

  /* Modo responsivo (mobile): vira um bloco acima do parágrafo */
  @media (max-width: 768px) {
    .nota {
      position: static;
      width: auto;
      margin: 0 0 0.6rem 0;
      padding: 0.5rem 0.75rem;
      border-left: 0.28rem solid var(--nota-cor);
      background: var(--nota-bg-mobile);
      border-radius: 0.5rem;
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      transform: none;
    }

    .nota .texto {
      font-size: 1rem;  /* ligeiramente maior para legibilidade no mobile */
      font-weight: 600;
    }

    .nota .icone {
      flex: 0 0 auto;
    }

    .nota-de-margem[data-lado="direita"] .nota,
    .nota-de-margem[data-lado="esquerda"] .nota {
      text-align: left; /* alinhamento natural em bloco */
    }
  }
</style>
